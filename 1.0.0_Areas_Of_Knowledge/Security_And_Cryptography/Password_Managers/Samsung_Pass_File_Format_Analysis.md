# Areas_Of_Knowledge\Security_And_Cryptography\Password_Managers\Samsung_Pass_File_Format_Analysis.md

### **三星密码本 (.spass) 文件加解密协议深度解析**

本技术文档对三星密码本（Samsung Pass）的 `.spass` 备份文件格式进行全面而深入的解析。内容基于对 **0xdeb7ef** 的开源项目 **spass-manager** 的逆向工程成果的研究，旨在详尽阐述文件的内部数据结构、加密与解密流程，以及其所采用的密码学技术栈。

---

#### **目录**

- [Areas\_Of\_Knowledge\\Security\_And\_Cryptography\\Password\_Managers\\Samsung\_Pass\_File\_Format\_Analysis.md](#areas_of_knowledgesecurity_and_cryptographypassword_managerssamsung_pass_file_format_analysismd)
    - [**三星密码本 (.spass) 文件加解密协议深度解析**](#三星密码本-spass-文件加解密协议深度解析)
      - [**目录**](#目录)
    - [引言](#引言)
      - [.spass 文件概述](#spass-文件概述)
      - [安全机制概览](#安全机制概览)
    - [第一部分：核心数据结构与预处理](#第一部分核心数据结构与预处理)
      - [1.1 内部数据结构：一种类 CSV 格式](#11-内部数据结构一种类-csv-格式)
        - [1.1.1 字段分隔符：分号 (;)](#111-字段分隔符分号-)
        - [1.1.2 数据类型边界：`next_table` 关键字](#112-数据类型边界next_table-关键字)
      - [1.2 数据编码策略：双重 Base64 编码](#12-数据编码策略双重-base64-编码)
        - [1.2.1 第一层：字段级编码](#121-第一层字段级编码)
        - [1.2.2 第二层：文件级编码](#122-第二层文件级编码)
    - [第二部分：加密协议详解](#第二部分加密协议详解)
      - [2.1 生成关键加密参数](#21-生成关键加密参数)
        - [2.1.1 随机盐 (Salt)：20 字节](#211-随机盐-salt20-字节)
        - [2.1.2 随机初始化向量 (IV)：16 字节](#212-随机初始化向量-iv16-字节)
      - [2.2 加密密钥派生：PBKDF2 算法](#22-加密密钥派生pbkdf2-算法)
        - [2.2.1 核心算法与参数](#221-核心算法与参数)
        - [2.2.2 密钥拉伸 (Key Stretching) 的重要性](#222-密钥拉伸-key-stretching-的重要性)
      - [2.3 核心数据加密：AES-256-CBC](#23-核心数据加密aes-256-cbc)
        - [2.3.1 算法与模式选择](#231-算法与模式选择)
        - [2.3.2 PKCS#7 填充机制](#232-pkcs7-填充机制)
      - [2.4 文件组装与最终封装](#24-文件组装与最终封装)
        - [2.4.1 组件拼接顺序](#241-组件拼接顺序)
        - [2.4.2 最终的 Base64 编码](#242-最终的-base64-编码)
    - [第三部分：解密流程详解](#第三部分解密流程详解)
      - [3.1 文件读取与初步解码](#31-文件读取与初步解码)
        - [3.1.1 读取与清理](#311-读取与清理)
        - [3.1.2 第一次 Base64 解码](#312-第一次-base64-解码)
      - [3.2 拆分加密组件](#32-拆分加密组件)
      - [3.3 重新派生加密密钥](#33-重新派生加密密钥)
      - [3.4 数据解密与填充移除](#34-数据解密与填充移除)
      - [3.5 最终解析与数据还原](#35-最终解析与数据还原)
        - [3.5.1 分割与解析](#351-分割与解析)
        - [3.5.2 第二次 Base64 解码](#352-第二次-base64-解码)
        - [3.5.3 可选的数据清洗](#353-可选的数据清洗)
    - [结论](#结论)
    - [致谢](#致谢)

---

### <a name="引言"></a>引言

#### <a name="spass-文件概述"></a>.spass 文件概述

三星密码本（Samsung Pass）是三星设备内置的一款密码管理工具，用于安全存储用户的网站登录凭证、银行卡信息及地址等敏感数据。 为便于用户在不同设备间迁移数据，三星密码本提供了数据导出功能，该功能会生成一个以 `.spass` 为后缀的加密备份文件。 此文件格式的设计目标是保证即使用户的备份文件意外泄露，其中存储的个人信息也难以被未经授权的第三方破解。

#### <a name="安全机制概览"></a>安全机制概览

`.spass` 文件采用了一套强大且符合行业标准的多层安全机制。其核心技术栈包括：

*   **密钥派生函数 (KDF)**：使用 PBKDF2 算法，通过高迭代次数将用户的主密码转换为一个高强度的加密密钥。
*   **对称加密算法**：采用 AES-256-CBC 算法，这是目前公认的最安全的对称加密标准之一。
*   **随机化**：通过为每次加密过程生成独立的盐 (Salt) 和初始化向量 (IV)，确保了加密输出的唯一性和不可预测性。

---

### <a name="第一部分"></a>第一部分：核心数据结构与预处理

在进入核心加密流程之前，应用程序首先将内部管理的各种数据统一为一种标准化的格式。此过程涉及数据结构化与编码两个关键步骤。

#### <a name="1-1"></a>1.1 内部数据结构：一种类 CSV 格式

所有待导出的凭证信息，包括登录凭证、银行卡、地址等，被统一组织成一种类似于 CSV（逗号分隔值）的文本格式。 其核心特点如下：

##### <a name="1-1-1"></a>1.1.1 字段分隔符：分号 (;)

与标准 CSV 使用逗号不同，`.spass` 内部格式采用分号 (`;`) 作为各个字段（如用户名、密码、网址、创建日期等）之间的分隔符。

##### <a name="1-1-2"></a>1.1.2 数据类型边界：`next_table` 关键字

不同的数据类别（例如，密码凭证、地址信息）之间，使用一个特殊的关键字 `next_table` 作为明确的边界分隔符。 这使得在解析时能够准确地区分不同类型的数据集合。

#### <a name="1-2"></a>1.2 数据编码策略：双重 Base64 编码

为了保证数据在加密和传输过程中的完整性，并防止特殊字符干扰后续处理流程，三星采用了一种严谨的“双重 Base64 编码”策略。

##### <a name="1-2-1"></a>1.2.1 第一层：字段级编码

将每一个独立的字段（例如，一个用户名、一个密码或一个网址）分别进行一次独立的 Base64 编码。 这一步确保了每个数据单元都被转换成安全的 ASCII 字符集。

##### <a name="1-2-2"></a>1.2.2 第二层：文件级编码

在后续加密流程的最后一步，整个加密后的二进制数据块（包含盐、IV 和密文）会再进行一次整体的 Base64 编码，最终生成 `.spass` 文件的可见内容。

经过此番结构化和编码处理的文本块，构成了等待加密的“核心明文数据”。

---

### <a name="第二部分"></a>第二部分：加密协议详解

加密是将预处理后的核心数据转化为安全的 `.spass` 文件的核心环节。该流程遵循了业界公认的密码学最佳实践，构建起坚固的安全防线。

#### <a name="2-1"></a>2.1 生成关键加密参数

为确保每次加密的输出都是唯一的，从而杜绝“相同密码、相同文件”的现象，程序会首先生成两个至关重要的随机参数：

##### <a name="2-1-1"></a>2.1.1 随机盐 (Salt)：20 字节

程序通过一个加密安全的伪随机数生成器（CSPRNG）创建一个 **20字节** 的随机盐。盐的核心作用是与用户的主密码结合，用于后续的密钥派生。这使得即使多个用户使用相同的主密码，他们派生出的加密密钥也完全不同，从而有效抵御彩虹表 (Rainbow Table) 和字典攻击。

##### <a name="2-1-2"></a>2.1.2 随机初始化向量 (IV)：16 字节

紧接着，程序会生成一个 **16字节** 的随机 IV。在 AES 的 CBC（密码块链接）模式下，IV 用于随机化第一个明文块的加密过程。其存在确保了即使是完全相同的明文数据，在每次加密时生成的密文也各不相同，极大地增强了加密的语义安全性。

#### <a name="2-2"></a>2.2 加密密钥派生：PBKDF2 算法

直接使用用户输入的主密码进行加密是极不安全的。为此，三星采用了强大的 **PBKDF2 (Password-Based Key Derivation Function 2)** 算法来派生一个高强度的加密密钥。

##### <a name="2-2-1"></a>2.2.1 核心算法与参数

*   **核心算法**: PBKDF2
*   **伪随机函数 (PRF)**: **HMAC-SHA-256**。这指定了 PBKDF2 内部迭代时使用的哈希函数为安全的 SHA-256。
*   **迭代次数**: **70,000次**。这是一个关键的安全参数。
*   **输入**:
    *   用户设置的主密码。
    *   第一步生成的 20 字节随机盐。
*   **输出**: 一个 **32字节 (256位)** 的派生密钥。

##### <a name="2-2-2"></a>2.2.2 密钥拉伸 (Key Stretching) 的重要性

通过执行 70,000 次哈希迭代，极大地增加了破解的计算成本。 这种被称为“密钥拉伸”的技术，使得攻击者即使获取了文件和盐，也需要耗费巨大的计算资源才能尝试破解一个猜测的密码，从而有效延缓了暴力破解的速度。

#### <a name="2-3"></a>2.3 核心数据加密：AES-256-CBC

使用上一步派生出的高强度密钥，对经过预处理的“核心数据”文本块进行对称加密。

##### <a name="2-3-1"></a>2.3.1 算法与模式选择

*   **加密算法**: **AES-256-CBC**。
    *   **AES (高级加密标准)**：目前最流行和安全的块加密算法之一，块大小为 128 位（16 字节）。
    *   **256位密钥**: 使用 32 字节的密钥长度，提供了极高的安全级别。
    *   **CBC (密码块链接模式)**：一种工作模式，通过将前一个密文块与下一个明文块进行异或操作，实现了加密块之间的关联，隐藏了明文数据的模式。

##### <a name="2-3-2"></a>2.3.2 PKCS#7 填充机制

AES 作为块加密算法，要求待加密的数据长度必须是其块大小（16 字节）的整数倍。 因此，在加密前，程序会自动在数据末尾添加符合 **PKCS#7** 标准的填充。 PKCS#7 填充规则能确保数据被正确地补齐至块边界，并且在解密后可以被无歧义地识别并安全移除。

#### <a name="2-4"></a>2.4 文件组装与最终封装

加密完成后，将各个独立的二进制组件按照精确的顺序拼接起来。

##### <a name="2-4-1"></a>2.4.1 组件拼接顺序

`[20字节盐] + [16字节IV] + [AES加密后的核心数据密文]`

将盐和 IV 明文存储在文件头部是一种标准做法。它们不属于秘密，其作用在于为解密过程提供必要的、公开的参数。

##### <a name="2-4-2"></a>2.4.2 最终的 Base64 编码

将这个拼接而成的完整二进制数据流进行一次整体的 Base64 编码，生成最终的、由 ASCII 字符组成的 `.spass` 文件内容。这就是用户在文本编辑器中打开文件时看到的字符串。

---

### <a name="第三部分"></a>第三部分：解密流程详解

解密是加密的逆向过程，其目标是从 `.spass` 文件和用户主密码中，安全、准确地还原出原始的凭证信息。

#### <a name="3-1"></a>3.1 文件读取与初步解码

##### <a name="3-1-1"></a>3.1.1 读取与清理
首先，程序读取 `.spass` 文件的全部内容，并清理掉文件内容末尾可能存在的任何空白字符（如换行符），以防干扰 Base64 解码。

##### <a name="3-1-2"></a>3.1.2 第一次 Base64 解码
对清理后的内容执行 Base64 解码，将其从 ASCII 字符串还原为加密时组装的二进制数据块 (`盐 + IV + 密文`)。

#### <a name="3-2"></a>3.2 拆分加密组件

根据加密时定义的固定长度和顺序，将解码后的二进制数据块精确地拆分成三个关键部分：
*   **前 20 字节**: 提取出加密时使用的**盐**。
*   **接下来的 16 字节**: 提取出**初始化向量 (IV)**。
*   **剩余部分**: 得到 AES 加密后的**核心数据密文**。

#### <a name="3-3"></a>3.3 重新派生加密密钥

为了成功解密数据，必须重新生成与加密时完全相同的密钥。
*   程序会提示用户输入其导出文件时设置的主密码。
*   使用与加密时完全相同的参数——即用户输入的主密码、从文件中提取的 20 字节盐、HMAC-SHA-256 伪随机函数以及 70,000 次迭代——来运行 PBKDF2 算法。
*   此过程会计算出一个 32 字节的派生密钥。如果用户输入的密码正确，该密钥将与加密时使用的密钥完全一致。

#### <a name="3-4"></a>3.4 数据解密与填充移除

*   使用上一步重新派生的密钥和从文件中提取的 IV，通过 AES-256-CBC 算法对密文进行解密。
*   解密成功后，程序会识别并安全地移除数据末尾的 PKCS#7 填充，从而得到纯净的、经过预处理的核心数据文本。

#### <a name="3-5"></a>3.5 最终解析与数据还原

此时得到的数据块仍是经过编码和结构化的，需要进一步逆向解析。

##### <a name="3-5-1"></a>3.5.1 分割与解析

首先，使用 `next_table` 关键字作为分隔符，将整个数据块分割成不同的部分（如密码、地址等）。在每个数据块内部，以换行符分割出单条记录，再以分号 (`;`) 作为分隔符切割出各个字段的 Base64 编码字符串。

##### <a name="3-5-2"></a>3.5.2 第二次 Base64 解码

对解析出的每一个字段，再次进行 Base64 解码（对应加密时的第一层编码），至此，才真正得到原始的、可读的明文信息。

##### <a name="3-5-3"></a>3.5.3 可选的数据清洗

最后，程序可能会对特定字段进行智能清洗，例如，将某些特定于安卓应用的网址链接（如 `androidapp://com.example.app`）转换为用户更易于理解和使用的标准网址。

---

### <a name="结论"></a>结论

三星密码本的 `.spass` 文件格式采用了一套经过深思熟虑且安全可靠的加密协议。通过结合行业标准的 PBKDF2、AES-256-CBC 算法和正确的密码学实践（如使用盐和 IV），它为用户的敏感数据提供了强大的保护。尽管这种专有格式旨在保护用户数据，但也给希望迁移到其他密码管理器的用户带来了不便。 对该文件格式的逆向工程分析不仅揭示了其内部工作原理，也为开发第三方工具以实现数据迁移提供了可能性。

---

### <a name="致谢"></a>致谢

本文对三星密码本 (`.spass`) 文件的深度解析与解密功能的实现，完全建立在 **0xdeb7ef** 在其开源项目 **[spass-manager](https://github.com/0xdeb7ef/spass-manager)** 中卓越的逆向工程工作之上。 我们的实现是对其核心逻辑的理解、重述和丰富。我们由衷感谢其为开源社区做出的宝贵贡献。