好的，我们来为 `PasswordManager-Icon-Fetcher-Service` (图标自动获取服务) 设计其需要暴露的 API。

这个项目是一个目的非常专一的微服务。它的消费者是**前端客户端** (`App-Main` 和 `Browser-Extension`)，因此它的 API 设计必须**高效、简单、且易于被缓存**。

### **核心职责回顾**

*   **输入**: 一个域名 (例如 `google.com`)。
*   **处理**: 在后台智能地查找最佳图标，处理成标准尺寸，并进行缓存。
*   **输出**: 一个可供前端直接使用的、稳定的图标图片 URL。

### **API 设计理念**

最佳实践是**不直接返回图片二进制数据**，而是返回一个**HTTP 重定向 (Redirect)** 到一个静态的、可被 CDN 缓存的图片 URL。这样做有巨大优势：

1.  **性能极高**: 客户端（手机App或浏览器）拿到重定向地址后，会自己去请求图片。这个图片地址可以指向一个 CDN（内容分发网络），加载速度极快。
2.  **善用缓存**: 浏览器和 App 的图片加载器会自动缓存图片。下次请求同一个图标时，可能直接从本地缓存加载，连网络请求都没有。
3.  **服务解耦**: 图标抓取逻辑（动态）和图片托管（静态）分离，服务更健壮。

---

### **API 端点详解**

这个服务只需要暴露一个核心的 API 端点。

#### **`GET /v1/icon`**

*   **描述**: 获取指定域名的最佳图标。服务会返回一个 HTTP 302 重定向，指向最终的图标图片 URL。客户端应自动跟随此重定向来加载图片。
*   **授权**: **需要**。为了防止服务被滥用（被其他人盗用），所有请求都应在 HTTP Header 中包含一个 API 密钥。
    *   `X-API-Key: your_secret_api_key_for_clients`
*   **查询参数 (Query Parameters)**:
    *   `domain` (string, **必需**): 需要获取图标的网站域名。例如: `google.com`。
    *   `size` (integer, 可选): 期望的图标尺寸（像素，正方形）。服务会返回最接近该尺寸的图标。如果未提供，默认为 `64`。常用值: `32`, `64`, `128`, `256`。
    *   `fallback` (string, 可选): 当找不到任何图标时，指定备用方案。
        *   `letter` (推荐): 生成一个带有域名首字母的彩色圆形背景图标（类似 Gmail 的默认头像）。
        *   如果不提供此参数且找不到图标，将返回 404。
*   **成功响应 (Success Response)**:
    *   **`302 Found`**:
        *   这是最主要的成功响应。
        *   **`Location` Header**: `https://cdn.mypasswordapp.com/icons/google.com_64.png`
        *   客户端（如 Flutter 的 `Image.network` 组件或浏览器的 `<img>` 标签）会自动处理这个重定向，请求 `Location` 头中的 URL 并显示图片。
*   **错误响应 (Error Responses)**:
    *   **`400 Bad Request`**: 如果 `domain` 参数缺失或格式不正确。
        ```json
        {
          "error": "Bad Request",
          "message": "The 'domain' query parameter is required."
        }
        ```
    *   **`401 Unauthorized`**: 如果 `X-API-Key` 缺失或无效。
    *   **`404 Not Found`**: 如果找不到指定域名的图标，并且没有设置 `fallback` 参数。
    *   **`503 Service Unavailable`**: 如果服务在尝试抓取图标时遇到内部错误（例如，目标网站无法访问）。客户端可以稍后重试。

### **工作流揭秘 (Behind the Scenes)**

当前端请求 `GET /v1/icon?domain=google.com&size=64` 时，服务内部会发生以下事情：

1.  **检查缓存**: 服务首先检查自己的缓存系统（如 Redis 或 S3 存储桶）中是否已经存在 `google.com` 的 64px 图标。
    *   **缓存命中**: 如果存在，立即返回 `302 Found`，`Location` 指向缓存中的图片 URL。这是最快的情况。
2.  **缓存未命中 (首次请求)**:
    *   服务立即向客户端返回一个**占位符图标**的 `302 Found` 重定向，或者暂时不返回，将请求挂起（取决于产品体验设计）。
    *   同时，在**后台异步启动一个抓取任务**：
        a.  **智能抓取**: 按照优先级顺序尝试多种方法获取图标：
            i.  解析目标网站 HTML 的 `<head>`，查找 `<link rel="apple-touch-icon">` (通常质量最高)。
            ii. 查找 `<link rel="icon" sizes="...">`。
            iii. 查找 Web App Manifest (`manifest.json`) 中定义的图标。
            iv. 尝试根目录的 `/favicon.ico`。
            v.  (备选) 调用第三方服务（如 Google S2 Converter）作为最后的手段。
        b.  **图像处理**: 找到最佳图片后，将其下载下来，裁剪、缩放成多种标准尺寸（如 32, 64, 128, 256px），并转换为统一格式（如 PNG）。
        c.  **存入缓存**: 将处理好的各尺寸图片存入缓存，并以域名和尺寸作为键（例如 `google.com_64.png`）。
3.  **后续请求**: 任何客户端再次请求 `google.com` 的图标时，都会直接命中缓存，实现秒级加载。

### **总结**

| API 端点 | HTTP 方法 | 用途 | 调用方 | 核心返回 |
| :--- | :--- | :--- | :--- | :--- |
| `/v1/icon` | `GET` | 根据域名获取图标 | Flutter 客户端 (项目3 & 4) | **`302 Found` 重定向** |

这个设计简单、高效且可扩展，完美地满足了前端应用对网站图标的需求，同时将复杂的抓取和处理逻辑封装在了后端服务中。