# Oracore API 参考文档

欢迎使用 Oracore！本篇文档是 Oracore 库的官方 API 参考。

## 核心理念

Oracore 的设计围绕着 `Vault` 这个核心对象。所有与密码库的交互都应通过 `Vault` 的实例来完成。它遵循一个严格的生命周期，以确保最大程度的安全：**创建/初始化 → 解锁 → 使用 → 锁定**。

---

## 1. `oracore.Vault`

这是与 Oracore 交互的主要类，是所有功能的入口。

### **`__init__(self, data_dir: str)`**

**功能:**
创建一个 Vault 实例，它代表磁盘上一个特定位置的加密密码库。

**参数:**
*   `data_dir (str)`: 存储保险库所有文件（数据库、salt 等）的目录路径。如果该目录不存在，将会被自动创建。

**示例:**
```python
from oracore import Vault

# 创建一个 Vault 实例，数据将存储在 './my_app_vault' 目录中
vault = Vault("./my_app_vault")
```

---

### **生命周期方法**

#### **`setup(self, master_password: str, min_length: int = 12) -> None`**

**功能:**
首次初始化保险库。此操作会生成加密所需的 salt，使用 Argon2id 从主密码派生出主密钥，并创建必要的验证文件和数据库。**此方法每个保险库只需调用一次。**

**参数:**
*   `master_password (str)`: 用户选择的主密码。
*   `min_length (int)`: 密码的最小长度要求。默认为 `12`。如果提供的密码短于此长度，将引发 `ValueError`。若要禁用此安全检查，请将此值设为 `0`。

**引发:**
*   `oracore.OracipherError`: 如果保险库已经被初始化过。
*   `ValueError`: 如果 `master_password` 的长度小于 `min_length`。

**示例:**
```python
master_password = "my-very-long-and-secure-password"
try:
    if not vault.is_setup:
        vault.setup(master_password)
        print("Vault successfully initialized!")
except ValueError as e:
    print(f"Error: {e}")
```

#### **`unlock(self, master_password: str) -> None`**

**功能:**
使用主密码解锁保险库。此操作会重新派生密钥，并用它解密一个验证令牌以确认密码是否正确。成功后，密钥会被加载到内存中，所有数据操作方法变为可用。

**参数:**
*   `master_password (str)`: 用户输入的主密码。

**引发:**
*   `oracore.VaultNotInitializedError`: 如果保险库尚未通过 `setup()` 初始化。
*   `oracore.IncorrectPasswordError`: 如果提供的主密码是错误的。
*   `oracore.CorruptDataError`: 如果保险库的验证文件已损坏。

**示例:**
```python
try:
    vault.unlock(master_password)
    print("Vault is unlocked and ready to use.")
except IncorrectPasswordError:
    print("Access denied: Incorrect password.")
```

#### **`lock(self) -> None`**

**功能:**
锁定保险库。此操作会从内存中安全地擦除加密密钥，并关闭数据库连接。这是在完成所有操作后**必须调用**的关键安全步骤。

**示例:**
```python
# ... 执行完操作后 ...
if vault.is_unlocked:
    vault.lock()
    print("Vault is now securely locked.")
```

---

### **状态属性**

#### **`is_setup`**

**返回:** `bool` - 如果保险库已初始化，则为 `True`，否则为 `False`。

#### **`is_unlocked`**

**返回:** `bool` - 如果保险库当前已解锁，则为 `True`，否则为 `False`。

---

### **数据管理 (CRUD)**

> **注意：** 以下所有方法都要求保险库处于**已解锁**状态。

#### **`save_entry(self, entry_data: dict) -> int`**

**功能:**
创建或更新一个条目。

**参数:**
*   `entry_data (dict)`: 一个包含条目信息的字典。
    *   若要**创建**新条目，字典中不应包含 `'id'` 键。
    *   若要**更新**现有条目，字典中必须包含该条目的 `'id'` 键。
    *   **结构示例:** `{'name': 'Google', 'category': 'Work', 'details': {'username': 'user', 'password': 'pass'}}`

**返回:** `int` - 被保存或更新条目的唯一 ID。

**引发:**
*   `oracore.VaultLockedError`: 如果保险库被锁定。

**示例:**
```python
# 创建一个新条目
new_id = vault.save_entry({
    "name": "My Website",
    "details": {"username": "admin", "password": "secret-password-123"}
})
print(f"Created new entry with ID: {new_id}")

# 更新该条目
vault.save_entry({
    "id": new_id,
    "name": "My Awesome Website", # 更新名称
    "details": {"username": "admin", "password": "new-secret-password-456"} # 更新密码
})
print(f"Updated entry with ID: {new_id}")
```

#### **`get_all_entries(self) -> list[dict]`**

**功能:**
获取保险库中的所有条目，并将它们一次性加载到一个列表中。

**返回:** `list[dict]` - 一个包含所有条目字典的列表。

**引发:**
*   `oracore.VaultLockedError`: 如果保险库被锁定。

**示例:**
```python
all_items = vault.get_all_entries()
print(f"Found {len(all_items)} items in the vault.")
```

#### **`get_all_entries_iter(self) -> Iterator[dict]`**

**功能:**
**(推荐)** 以迭代器（生成器）的形式逐一获取保险库中的所有条目。这种方法内存效率极高，是处理大型保险库的最佳选择。

**返回:** `Iterator[dict]` - 一个可以用于 `for` 循环的条目迭代器。

**引发:**
*   `oracore.VaultLockedError`: 如果保险库被锁定。

**示例:**
```python
print("All entries in vault:")
for entry in vault.get_all_entries_iter():
    print(f"- {entry['name']} (ID: {entry['id']})")
```

#### **`delete_entry(self, entry_id: int) -> None`**

**功能:**
根据指定的 ID 删除一个条目。

**参数:**
*   `entry_id (int)`: 要删除条目的唯一 ID。

**引发:**
*   `oracore.VaultLockedError`: 如果保险库被锁定。

**示例:**
```python
# 假设我们要删除 ID 为 5 的条目
vault.delete_entry(5)
print("Entry with ID 5 has been deleted.")
```

---

### **高级操作**

#### **`change_master_password(self, old_password: str, new_password: str, min_length: int = 12) -> None`**

**功能:**
更改保险库的主密码。此操作会验证旧密码，然后用新密码派生的密钥重新加密整个数据库，过程安全可靠。

**参数:**
*   `old_password (str)`: 当前的主密码。
*   `new_password (str)`: 新的主密码。
*   `min_length (int)`: 新密码的最小长度要求。默认为 `12`。

**引发:**
*   `oracore.VaultLockedError`: 如果保险库被锁定。
*   `oracore.IncorrectPasswordError`: 如果 `old_password` 不正确。
*   `ValueError`: 如果 `new_password` 的长度小于 `min_length`。

**示例:**
```python
try:
    vault.change_master_password("old-secure-password", "new-even-more-secure-password")
    print("Master password changed successfully.")
except IncorrectPasswordError:
    print("Failed to change password: The old password was incorrect.")
```

#### **`destroy_vault(self) -> None`**

**功能:**
**(危险操作)** 永久并安全地删除整个保险库，包括其目录和所有相关文件。**此操作不可逆。**

**引发:**
*   `oracore.VaultLockedError`: 如果保险库被锁定。

---

## 2. `oracore.data_formats`

这是一个辅助模块，用于处理不同数据格式的导入和导出。

### **`export_to_csv(entries: list[dict]) -> str`**

**功能:**
将一个条目列表转换为 CSV 格式的字符串。

**参数:**
*   `entries (list[dict])`: 从 `vault.get_all_entries()` 获取的条目列表。

**返回:** `str` - CSV 格式的数据。

**示例:**
```python
from oracore import data_formats

entries = vault.get_all_entries()
csv_string = data_formats.export_to_csv(entries)
with open("export.csv", "w", encoding="utf-8") as f:
    f.write(csv_string)
```

### **`import_from_file(file_path: str, file_content_bytes: bytes, password: str | None = None) -> list[dict]`**

**功能:**
一个智能的导入函数，可以自动检测并解析多种外部文件格式。

**参数:**
*   `file_path (str)`: 文件的完整路径（用于检测文件扩展名）。
*   `file_content_bytes (bytes)`: 文件的原始字节内容。
*   `password (str | None)`: 对于需要解密的格式（如 Samsung Pass 的 `.spass` 文件），必须提供密码。默认为 `None`。

**返回:** `list[dict]` - 一个解析出的、符合 Oracore 格式的条目字典列表。

**引发:**
*   `oracore.InvalidFileFormatError`: 如果文件格式不受支持或解析失败。

---

## 3. `oracore.exceptions`

Oracore 定义了一套自定义异常，以便您能编写出更健壮的错误处理代码。所有异常都继承自 `OracipherError`。

-   **`OracipherError`**: 所有 Oracore 异常的基类。
-   **`IncorrectPasswordError`**: 在 `unlock()` 或 `change_master_password()` 时密码错误。
-   **`VaultNotInitializedError`**: 在 `setup()` 之前尝试 `unlock()`。
-   **`VaultLockedError`**: 在保险库锁定时尝试进行数据操作。
-   **`CorruptDataError`**: 当加密数据（或验证文件）被篡改或损坏时。
-   **`InvalidFileFormatError`**: 当使用 `data_formats.import_from_file` 或 `vault.import_from_skey` 时，文件格式错误、损坏或解密密码错误。